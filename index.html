<!DOCTYPE html>
<html>
<head>
  <title>Tauron Reader</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Sekcja wykres√≥w - Grafana style */
    .chart-section {
      width: 100%;
      background: #161b22;
      height: 230px;
      display: flex;
      flex-direction: column;
      border-bottom: 1px solid #30363d;
    }
    .chart-top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 15px;
      background: linear-gradient(180deg, #161b22 0%, #0d1117 100%);
      border-bottom: 1px solid #30363d;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      height: 30px;
      flex-shrink: 0;
    }
    .chart-title {
      font-size: 14px;
      font-weight: 700;
      color: #58a6ff;
      letter-spacing: 0.3px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    .chart-tabs {
      display: flex;
      gap: 5px;
    }
    .chart-tab {
      padding: 5px 12px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      color: #8b949e;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    .chart-tab:hover {
      background: #30363d;
      color: #c9d1d9;
    }
    .chart-tab.active {
      background: #1f6feb;
      color: white;
      border-color: #1f6feb;
    }
    .chart-menu {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .checkbox-group {
      display: flex;
      gap: 12px;
    }
    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      cursor: pointer;
      user-select: none;
      color: #8b949e;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .checkbox-group label:hover {
      background: rgba(88, 166, 255, 0.1);
      color: #c9d1d9;
    }
    .checkbox-group input[type="checkbox"] {
      cursor: pointer;
      width: 14px;
      height: 14px;
    }
    .btn {
      background: linear-gradient(180deg, #2ea043 0%, #238636 100%);
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      letter-spacing: 0.3px;
    }
    .btn:hover {
      background: linear-gradient(180deg, #3fb950 0%, #2ea043 100%);
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.4);
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .btn-secondary {
      background: linear-gradient(180deg, #388bfd 0%, #1f6feb 100%);
    }
    .btn-secondary:hover {
      background: linear-gradient(180deg, #58a6ff 0%, #388bfd 100%);
    }

    .chart-container {
      position: relative;
      height: 200px;
      background: #0d1117;
      padding: 10px 15px;
    }

    /* Sekcje dolne */
    .content-sections {
      display: flex;
      flex: 1;
      overflow: hidden;
      gap: 1px;
      background: #30363d;
    }

    .section {
      flex: 1;
      background: #161b22;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .section-header {
      background: linear-gradient(180deg, #161b22 0%, #0d1117 100%);
      padding: 5px 15px;
      border-bottom: 1px solid #30363d;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      height: 30px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-title {
      font-size: 13px;
      font-weight: 700;
      color: #58a6ff;
      letter-spacing: 0.3px;
    }

    .section-count {
      font-size: 10px;
      color: #8b949e;
    }

    .section-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #0d1117;
    }

    /* Logi */
    .log-entry {
      background: #161b22;
      border-left: 3px solid #3fb950;
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 11px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }
    .log-entry:hover {
      background: #1c2128;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transform: translateX(2px);
    }
    .log-entry.error {
      border-left-color: #f85149;
    }
    .log-time {
      color: #8b949e;
      font-size: 10px;
    }
    .log-message {
      margin-top: 3px;
      color: #c9d1d9;
    }

    /* Status */
    .status-item {
      background: #161b22;
      padding: 12px 14px;
      margin-bottom: 10px;
      border-radius: 8px;
      font-size: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      border: 1px solid #21262d;
      transition: all 0.2s;
    }
    .status-item:hover {
      border-color: #30363d;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .status-label {
      color: #8b949e;
      font-size: 11px;
      margin-bottom: 4px;
    }
    .status-value {
      color: #c9d1d9;
      font-weight: 500;
    }
    .status-value.success {
      color: #3fb950;
    }
    .status-value.error {
      color: #f85149;
    }
    .status-value.warning {
      color: #d29922;
    }

    .schedule-item {
      display: inline-block;
      background: #21262d;
      padding: 4px 8px;
      margin: 2px;
      border-radius: 4px;
      font-size: 11px;
      color: #58a6ff;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #0d1117;
    }
    ::-webkit-scrollbar-thumb {
      background: #30363d;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #484f58;
    }
  </style>
</head>
<body>
  <!-- Sekcja wykres√≥w - Grafana style -->
  <div class="chart-section">
    <div class="chart-top-bar">
      <div style="display: flex; gap: 15px; align-items: center;">
        <div class="chart-title">üìä Produkcja i zu≈ºycie energii - 12 miesiƒôcy</div>
        <div class="year-selector">
          <div id="yearCheckboxes" style="display: flex; gap: 8px; flex-wrap: wrap;">
            <!-- Year checkboxes will be populated by JavaScript -->
          </div>
        </div>
      </div>
      <div class="chart-menu">
        <div class="checkbox-group" id="chartOptions">
          <label>
            <input type="checkbox" id="showProduction" checked onchange="updateChart()">
            <span>üü¢ Produkcja</span>
          </label>
          <label>
            <input type="checkbox" id="showConsumption" checked onchange="updateChart()">
            <span>üî¥ Zu≈ºycie</span>
          </label>
        </div>
        <button class="btn btn-secondary" onclick="runNow()">‚ñ∂Ô∏è Uruchom</button>
      </div>
    </div>
    <div class="chart-container">
      <canvas id="energyChart"></canvas>
    </div>
  </div>

  <!-- Sekcje dolne -->
  <div class="content-sections">
    <!-- Logi -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">üìù Logi i aktualizacje</div>
        <div class="section-count">{{LOG_COUNT}} wpis√≥w</div>
      </div>
      <div class="section-content">
        {{LOG_ENTRIES}}
        {{EMPTY_LOGS_MESSAGE}}
      </div>
    </div>

    <!-- Status i podsumowanie -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">‚ÑπÔ∏è Status i podsumowanie</div>
      </div>
      <div class="section-content">

      <div class="status-item">
        <div class="status-label">OSTATNIA AKTUALIZACJA</div>
        <div class="status-value">{{LATEST_UPDATE}}</div>
      </div>

      <div class="status-item">
        <div class="status-label">DZISIAJ</div>
        <div class="status-value">‚ö° {{TODAY_CONSUMPTION}} kWh zu≈ºycie</div>
        <div class="status-value">‚òÄÔ∏è {{TODAY_PRODUCTION}} kWh produkcja</div>
      </div>

      <div class="status-item">
        <div class="status-label">TEN TYDZIE≈É</div>
        <div class="status-value">‚ö° {{WEEK_CONSUMPTION}} kWh zu≈ºycie</div>
        <div class="status-value">‚òÄÔ∏è {{WEEK_PRODUCTION}} kWh produkcja</div>
      </div>

      <div class="status-item">
        <div class="status-label">WCZORAJ</div>
        <div class="status-value">‚ö° {{YESTERDAY_CONSUMPTION}} kWh zu≈ºycie</div>
        <div class="status-value">‚òÄÔ∏è {{YESTERDAY_PRODUCTION}} kWh produkcja</div>
      </div>

      <div class="status-item">
        <div class="status-label">PO≈ÅƒÑCZENIE TAURON</div>
        <div class="status-value success" id="tauronStatus">üü¢ Aktywne</div>
      </div>

      <div class="status-item">
        <div class="status-label">PO≈ÅƒÑCZENIE BAZA DANYCH</div>
        <div class="status-value success" id="dbStatus">üü¢ Aktywne</div>
      </div>

      <div class="status-item">
        <div class="status-label">ZAPLANOWANE URUCHOMIENIA</div>
        <div class="status-value">
          {{SCHEDULED_TIMES}}
        </div>
      </div>
      </div>
    </div>
  </div>

  <script>
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
      console.error('Chart.js not loaded');
      document.querySelector('.chart-container').innerHTML =
        '<div style="color: #f85149; text-align: center; padding: 40px;">‚ùå Chart.js nie zosta≈Ç za≈Çadowany</div>';
    }

    // Ingress path support for Home Assistant
    var basePath = window.location.pathname.replace(/\/$/, '');

    // Chart setup
    var ctx = document.getElementById('energyChart').getContext('2d');
    var chart = null;
    var currentChartType = 'yearly'; // default - 12 months
    var availableYears = [];
    var selectedYear = new Date().getFullYear();

    function switchChartType(type, event) {
      currentChartType = type;

      // Update active tab
      var tabs = document.querySelectorAll('.chart-tab');
      for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
      }
      if (event && event.target) {
        event.target.classList.add('active');
      }

      // Update title and options
      var titleEl = document.querySelector('.chart-title');
      var optionsEl = document.getElementById('chartOptions');

      if (type === 'monthly') {
        titleEl.textContent = 'üìä Produkcja energii';
        optionsEl.innerHTML = '<label><input type="checkbox" id="showProduction" checked onchange="updateChart()"><span>üü¢ Produkcja</span></label>';
      } else if (type === '2years') {
        titleEl.textContent = 'üìä Produkcja i zu≈ºycie - 2 lata';
        optionsEl.innerHTML = '<label><input type="checkbox" id="showProduction" checked onchange="updateChart()"><span>üü¢ Produkcja</span></label><label><input type="checkbox" id="showConsumption" checked onchange="updateChart()"><span>üî¥ Zu≈ºycie</span></label>';
      } else if (type === 'yearly') {
        titleEl.textContent = 'üìä Od roku do teraz';
        optionsEl.innerHTML = '<label><input type="checkbox" id="showProduction" checked onchange="updateChart()"><span>üü¢ Produkcja</span></label>';
      } else {
        titleEl.textContent = 'üìä Ostatnie 24h';
        optionsEl.innerHTML = '<label><input type="checkbox" id="showProduction" checked onchange="updateChart()"><span>üü¢ Produkcja</span></label><label><input type="checkbox" id="showConsumption" checked onchange="updateChart()"><span>üî¥ Zu≈ºycie</span></label>';
      }

      updateChart();
    }

    function updateChart() {
      var showProductionEl = document.getElementById('showProduction');
      var showConsumptionEl = document.getElementById('showConsumption');
      var showProduction = showProductionEl ? showProductionEl.checked : true;
      var showConsumption = showConsumptionEl ? showConsumptionEl.checked : true;

      // Get selected years
      var selectedYears = [];
      availableYears.forEach(function(year) {
        var checkbox = document.getElementById('year_' + year);
        if (checkbox && checkbox.checked) {
          selectedYears.push(year);
        }
      });

      // If no years selected, default to current year
      if (selectedYears.length === 0) {
        selectedYears = [new Date().getFullYear()];
        // Check the current year checkbox
        var currentYearCheckbox = document.getElementById('year_' + selectedYears[0]);
        if (currentYearCheckbox) {
          currentYearCheckbox.checked = true;
        }
      }

      console.log('Selected years:', selectedYears);

      // Fetch data for all selected years
      var promises = selectedYears.map(function(year) {
        return fetch(basePath + '/api/chart-data-yearly?year=' + year)
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.success) {
              data.year = year;
              return data;
            } else {
              console.error('Failed to load data for year', year, ':', data.error);
              return null;
            }
          });
      });

      Promise.all(promises)
        .then(function(yearDataArray) {
          // Filter out failed requests
          yearDataArray = yearDataArray.filter(function(data) { return data !== null; });

          if (yearDataArray.length === 0) {
            console.warn('No data available for selected years');
            document.querySelector('.chart-container').innerHTML =
              '<div style="color: #8b949e; text-align: center; padding: 40px;">üìä Brak danych dla wybranych lat</div>';
            return;
          }

          var datasets = [];
          var dataLength = 12; // Always 12 months

          // Create opacity gradient - newer years have higher opacity
          var yearCount = yearDataArray.length;

          yearDataArray.forEach(function(yearData, yearIndex) {
            // Calculate opacity: older years (0.1) to newer years (0.8)
            var baseOpacity = 0.1 + (yearIndex / yearCount) * 0.7;

            // Always show production (with checkbox control)
            if (showProduction) {
              datasets.push({
                label: 'Produkcja ' + yearData.year + ' (kWh)',
                data: yearData.production,
                borderColor: '#3fb950',
                backgroundColor: yearData.production.map(function(_, i) {
                  return 'rgba(63, 185, 80, ' + (baseOpacity + (i / dataLength) * 0.3) + ')';
                }),
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                pointBackgroundColor: '#3fb950',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 1,
                pointRadius: 3
              });
            }

            // Always show consumption (with checkbox control)
            if (showConsumption) {
              datasets.push({
                label: 'Zu≈ºycie ' + yearData.year + ' (kWh)',
                data: yearData.consumption,
                borderColor: '#f85149',
                backgroundColor: yearData.consumption.map(function(_, i) {
                  return 'rgba(248, 81, 73, ' + (baseOpacity + (i / dataLength) * 0.3) + ')';
                }),
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                pointBackgroundColor: '#f85149',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 1,
                pointRadius: 3
              });
            }
          });

          if (chart) chart.destroy();

          // Recreate canvas if it was replaced with error message
          var container = document.querySelector('.chart-container');
          if (!document.getElementById('energyChart')) {
            container.innerHTML = '<canvas id="energyChart"></canvas>';
          }

          var newCtx = document.getElementById('energyChart').getContext('2d');

          if (typeof Chart === 'undefined') {
            console.error('Chart.js not available for chart creation');
            document.querySelector('.chart-container').innerHTML =
              '<div style="color: #f85149; text-align: center; padding: 40px;">‚ùå Chart.js niedostƒôpny</div>';
            return;
          }

          try {
            chart = new Chart(newCtx, {
              type: 'line',
              data: {
                labels: ['Sty', 'Lut', 'Mar', 'Kwi', 'Maj', 'Cze', 'Lip', 'Sie', 'Wrz', 'Pa≈∫', 'Lis', 'Gru'],
                datasets: datasets
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: true,
                    position: 'top',
                    labels: {
                      color: '#c9d1d9',
                      font: { size: 10 },
                      usePointStyle: true,
                      padding: 10
                    }
                  },
                  tooltip: {
                    mode: 'index',
                    intersect: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: '#21262d'
                    },
                    ticks: {
                      color: '#8b949e',
                      font: { size: 10 },
                      callback: function(value) {
                        return value + ' kWh';
                      }
                    }
                  },
                  x: {
                    grid: {
                      color: '#21262d'
                    },
                    ticks: {
                      color: '#8b949e',
                      font: { size: 10 }
                    }
                  }
                }
              }
            });
          } catch (chartError) {
            console.error('Chart creation error:', chartError);
            document.querySelector('.chart-container').innerHTML =
              '<div style="color: #f85149; text-align: center; padding: 40px;">‚ùå B≈ÇƒÖd tworzenia wykresu: ' + chartError.message + '</div>';
            return;
          }
        })
        .catch(function(err) {
          console.error('Chart update error:', err);
        });
    }

    function loadAvailableYears() {
      fetch(basePath + '/api/available-years')
        .then(function(response) { return response.json(); })
        .then(function(data) {
          if (data.success && data.years && data.years.length > 0) {
            availableYears = data.years.sort(function(a, b) { return b - a; }); // Sort descending (newest first)

            var container = document.getElementById('yearCheckboxes');
            if (!container) {
              console.error('Year checkboxes container not found');
              return;
            }

            container.innerHTML = ''; // Clear existing content

            // Limit to maximum 5 years for UI clarity
            var yearsToShow = availableYears.slice(0, 5);

            yearsToShow.forEach(function(year, index) {
              var checkboxDiv = document.createElement('div');
              checkboxDiv.className = 'year-checkbox-item';
              checkboxDiv.style.cssText = 'display: inline-block; margin: 0 8px 4px 0;';

              var checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.id = 'year_' + year;
              checkbox.value = year;
              checkbox.style.cssText = 'margin-right: 4px; cursor: pointer;';

              // Default: check the most recent year
              if (index === 0) {
                checkbox.checked = true;
              }

              var label = document.createElement('label');
              label.htmlFor = 'year_' + year;
              label.textContent = year;
              label.style.cssText = 'color: #c9d1d9; font-size: 12px; cursor: pointer; user-select: none;';

              // Add hover effect
              checkboxDiv.onmouseover = function() {
                this.style.backgroundColor = '#21262d';
              };
              checkboxDiv.onmouseout = function() {
                this.style.backgroundColor = 'transparent';
              };

              // Add change event listener
              checkbox.onchange = function() {
                updateChart();
              };

              checkboxDiv.appendChild(checkbox);
              checkboxDiv.appendChild(label);
              container.appendChild(checkboxDiv);
            });

            console.log('Available years loaded:', availableYears);
            updateChart(); // Initial chart load
          } else {
            console.warn('No years available or failed to load years:', data);
            // Fallback to current year
            availableYears = [new Date().getFullYear()];
            updateChart();
          }
        })
        .catch(function(err) {
          console.error('Failed to load available years:', err);
          // Fallback to current year
          availableYears = [new Date().getFullYear()];
          updateChart();
        });
    }

    function runNow() {
      if (confirm('Uruchomiƒá pobieranie danych teraz?')) {
        fetch(basePath + '/run-now').then(function() {
          setTimeout(function() { location.reload(); }, 2000);
        });
      }
    }

    // Initialize
    loadAvailableYears();
    updateChart();

    // Auto-refresh every 60 seconds
    setInterval(function() {
      updateChart(); // Update chart only, not full page reload
    }, 60000);
  </script>
</body>
</html>